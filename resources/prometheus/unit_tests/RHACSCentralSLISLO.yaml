rule_files:
  - /tmp/prometheus-rules-test.yaml

evaluation_interval: 30s

group_eval_order:
  - rhacs-central.sli
  - rhacs-central.slo
  - rhacs-central.alerts

tests:
  # Ensure that a service with zero requests doesn't fire an alert
  - interval: 5m
    input_series:
      - series: kube_deployment_status_replicas_ready{deployment="central", namespace="rhacs-aaaabbbbccccddddeeee"}
        values: "1x1000"
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="OK", namespace="rhacs-aaaabbbbccccddddeeee", rhacs_instance_id="aaaabbbbccccddddeeee"}
        values: "1x1000"
      - series: haproxy_backend_http_responses_total{job="router_internal_default", code="2xx", exported_namespace="rhacs-aaaabbbbccccddddeeee"}
        values: "1x1000"
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="Unavailable", namespace="rhacs-aaaabbbbccccddddeeee", rhacs_instance_id="aaaabbbbccccddddeeee"}
        values: "0x1000"
      - series: haproxy_backend_http_responses_total{job="router_internal_default", code="5xx", exported_namespace="rhacs-aaaabbbbccccddddeeee"}
        values: "0x1000"
    alert_rule_test:
      - eval_time: 500m
        alertname: Central availability error budget exhaustion - 50%
        exp_alerts: []
  # Ensure that a service with zero requests but the pod is down *does* fire an alert
  - interval: 5m
    input_series:
      - series: kube_deployment_status_replicas_ready{deployment="central", namespace="rhacs-aaaabbbbccccddddeeee"}
        values: "0x1000"
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="OK", namespace="rhacs-aaaabbbbccccddddeeee", rhacs_instance_id="aaaabbbbccccddddeeee"}
        values: "1x1000"
      - series: haproxy_backend_http_responses_total{job="router_internal_default", code="2xx", exported_namespace="rhacs-aaaabbbbccccddddeeee"}
        values: "1x1000"
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="Unavailable", namespace="rhacs-aaaabbbbccccddddeeee", rhacs_instance_id="aaaabbbbccccddddeeee"}
        values: "0x1000"
      - series: haproxy_backend_http_responses_total{job="router_internal_default", code="5xx", exported_namespace="rhacs-aaaabbbbccccddddeeee"}
        values: "0x1000"
    alert_rule_test:
      - eval_time: 500m
        alertname: Central availability error budget exhaustion - 90%
        exp_alerts:
          - exp_labels:
              alertname: Central availability error budget exhaustion - 90%
              service: central
              severity: critical
              namespace: rhacs-aaaabbbbccccddddeeee
              rhacs_instance_id: aaaabbbbccccddddeeee
            exp_annotations:
              message: "High availability error budget exhaustion for central. Current exhaustion: 124.1%."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-018-rhacs-central-slo-alerts.md"
  # Central availability error budget exhaustion - 90%
  - interval: 5m
    input_series:
      # 200m downtime due to pod not ready. Out of 28 days, this equates to ~0.5% downtime.
      - series: kube_deployment_status_replicas_ready{deployment="central", namespace="rhacs-aaaabbbbccccddddeeee"}
        values: "1+0x260 0+0x40 1+0x100"
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="OK", namespace="rhacs-aaaabbbbccccddddeeee", rhacs_instance_id="aaaabbbbccccddddeeee"}
        values: "1+1x400"
      - series: haproxy_backend_http_responses_total{job="router_internal_default", code="2xx", exported_namespace="rhacs-aaaabbbbccccddddeeee"}
        values: "4+4x400"
      # 200m downtime due Unavailable or 5xx responses. Out of 28 days, this equates to ~0.5% downtime.
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="Unavailable", namespace="rhacs-aaaabbbbccccddddeeee", rhacs_instance_id="aaaabbbbccccddddeeee"}
        values: "0+0x360 0+1x40"
      - series: haproxy_backend_http_responses_total{job="router_internal_default", code="5xx", exported_namespace="rhacs-aaaabbbbccccddddeeee"}
        values: "0+0x360 0+4x40"
    alert_rule_test:
      - eval_time: 100m
        alertname: Central availability error budget exhaustion - 90%
        exp_alerts: []
      - eval_time: 2000m
        alertname: Central availability error budget exhaustion - 90%
        exp_alerts:
          - exp_labels:
              alertname: Central availability error budget exhaustion - 90%
              service: central
              severity: critical
              namespace: rhacs-aaaabbbbccccddddeeee
              rhacs_instance_id: aaaabbbbccccddddeeee
            exp_annotations:
              message: "High availability error budget exhaustion for central. Current exhaustion: 97.97%."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-018-rhacs-central-slo-alerts.md"

  # Central availability error budget exhaustion - 70%
  - interval: 5m
    input_series:
      # 175m downtime due to pod not ready. Out of 28 days, this equates to ~0.43% downtime.
      - series: kube_deployment_status_replicas_ready{deployment="central", namespace="rhacs-ffffgggghhhhiiiijjjj"}
        values: "1+0x265 0+0x35 1+0x100"
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="OK", namespace="rhacs-ffffgggghhhhiiiijjjj", rhacs_instance_id="ffffgggghhhhiiiijjjj"}
        values: "1+1x400"
      - series: haproxy_backend_http_responses_total{job="router_internal_default", code="2xx", exported_namespace="rhacs-ffffgggghhhhiiiijjjj"}
        values: "4+4x400"
      # 175m downtime due Unavailable or 5xx responses. Out of 28 days, this equates to ~0.43% downtime.
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="Unavailable", namespace="rhacs-ffffgggghhhhiiiijjjj", rhacs_instance_id="ffffgggghhhhiiiijjjj"}
        values: "0+0x365 0+1x35"
      - series: haproxy_backend_http_responses_total{job="router_internal_default", code="5xx", exported_namespace="rhacs-ffffgggghhhhiiiijjjj"}
        values: "0+0x365 0+4x35"
    alert_rule_test:
      - eval_time: 100m
        alertname: Central availability error budget exhaustion - 70%
        exp_alerts: []
      - eval_time: 2000m
        alertname: Central availability error budget exhaustion - 70%
        exp_alerts:
          - exp_labels:
              alertname: Central availability error budget exhaustion - 70%
              service: central
              severity: warning
              namespace: rhacs-ffffgggghhhhiiiijjjj
              rhacs_instance_id: ffffgggghhhhiiiijjjj
            exp_annotations:
              message: "High availability error budget exhaustion for central. Current exhaustion: 85.57%."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-018-rhacs-central-slo-alerts.md"

  # Central availability error budget exhaustion - 50%
  - interval: 5m
    input_series:
      # 105m downtime due to pod not ready. Out of 28 days, this equates to ~0.25% downtime.
      - series: kube_deployment_status_replicas_ready{deployment="central", namespace="rhacs-kkkkllllmmmmnnnnoooo"}
        values: "1+0x279 0+0x21 1+0x100"
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="OK", namespace="rhacs-kkkkllllmmmmnnnnoooo", rhacs_instance_id="kkkkllllmmmmnnnnoooo"}
        values: "1+1x400"
      - series: haproxy_backend_http_responses_total{job="router_internal_default", code="2xx", exported_namespace="rhacs-kkkkllllmmmmnnnnoooo"}
        values: "4+4x400"
      # 105m downtime due Unavailable or 5xx responses. Out of 28 days, this equates to ~0.25% downtime.
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="Unavailable", namespace="rhacs-kkkkllllmmmmnnnnoooo", rhacs_instance_id="kkkkllllmmmmnnnnoooo"}
        values: "0+0x379 0+1x21"
      - series: haproxy_backend_http_responses_total{job="router_internal_default", code="5xx", exported_namespace="rhacs-kkkkllllmmmmnnnnoooo"}
        values: "0+0x379 0+4x21"
    alert_rule_test:
      - eval_time: 100m
        alertname: Central availability error budget exhaustion - 50%
        exp_alerts: []
      - eval_time: 2000m
        alertname: Central availability error budget exhaustion - 50%
        exp_alerts:
          - exp_labels:
              alertname: Central availability error budget exhaustion - 50%
              service: central
              severity: warning
              namespace: rhacs-kkkkllllmmmmnnnnoooo
              rhacs_instance_id: kkkkllllmmmmnnnnoooo
            exp_annotations:
              message: "High availability error budget exhaustion for central. Current exhaustion: 50.84%."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-018-rhacs-central-slo-alerts.md"

  # Central high availability burn rate
  - interval: 5m
    input_series:
      # 30m downtime due to pod not ready.
      - series: kube_deployment_status_replicas_ready{deployment="central", namespace="rhacs-ppppqqqqrrrrsssstttt"}
        values: "1+0x6 0+0x6"
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="OK", namespace="rhacs-ppppqqqqrrrrsssstttt"}
        values: "5+5x14"
      - series: haproxy_backend_http_responses_total{job="router_internal_default", code="2xx", exported_namespace="rhacs-ppppqqqqrrrrsssstttt"}
        values: "5+5x14"
    alert_rule_test:
      - eval_time: 30m
        alertname: Central high availability burn rate
        exp_alerts: []
      - eval_time: 70m
        alertname: Central high availability burn rate
        exp_alerts:
          - exp_labels:
              alertname: Central high availability burn rate
              service: central
              severity: critical
              namespace: rhacs-ppppqqqqrrrrsssstttt
              rhacs_instance_id: ppppqqqqrrrrsssstttt
            exp_annotations:
              message: "High availability burn rate for central. Current burn rate per hour: 59.17."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-018-rhacs-central-slo-alerts.md"

  # Test central GRPC/HTTP API latency alerts and rules
  - interval: 10m
    input_series:
      - series: central:grpc_server_handling_seconds:rate10m:p90{namespace="rhacs-abc", grpc_service="grpcsvc", grpc_method="grpcmeth"}
        values: 1+0x4000
      - series: central:http_incoming_request_duration_histogram_seconds_bucket:rate10m:p90{namespace="rhacs-abc", grpc_service="grpcsvc", grpc_method="grpcmeth"}
        values: 1+0x4000
    alert_rule_test:
      # Ensure alert for a 28d window doesn't fire if there aren't enough SLI samples.
      - eval_time: 28d
        alertname: Central latency error budget exhaustion for GRPC API - 90%
        exp_alerts: []
      # Ensure alert for a 28d window doesn't fire if there aren't enough SLI samples.
      - eval_time: 28d
        alertname: Central latency error budget exhaustion for HTTP API - 90%
        exp_alerts: []
  - interval: 10m
    input_series:
      - series: central:grpc_server_handling_seconds:rate10m:p90{namespace="rhacs-abc", grpc_service="grpcsvc", grpc_method="grpcmeth"}
        values: "1+0x3994 0+0x36"
      - series: central:http_incoming_request_duration_histogram_seconds_bucket:rate10m:p90{namespace="rhacs-abc", grpc_service="grpcsvc", grpc_method="grpcmeth"}
        values: "1+0x3994 0+0x36"
    alert_rule_test:
      - eval_time: 28d
        alertname: Central latency error budget exhaustion for GRPC API - 90%
        exp_alerts:
          - exp_labels:
              alertname: Central availability error budget exhaustion - 90%
              namespace: rhacs-abc
              rhacs_instance_id: rhacs-abc
              service: central
              grpc_service: grpcsvc
              grpc_method: grpcmeth
              severity: critical
            exp_annotations:
              message: "Latency error budget exhaustion for central's GRPC API. Current exhaustion: 91.77%."
      - eval_time: 28d
        alertname: Central latency error budget exhaustion for GRPC API - 70%
        exp_alerts:
          - exp_labels:
              alertname: Central availability error budget exhaustion - 70%
              namespace: rhacs-abc
              rhacs_instance_id: rhacs-abc
              service: central
              grpc_service: grpcsvc
              grpc_method: grpcmeth
              severity: warning
            exp_annotations:
              message: "Latency error budget exhaustion for central's GRPC API. Current exhaustion: 91.77%."
      - eval_time: 28d
        alertname: Central latency error budget exhaustion for GRPC API - 50%
        exp_alerts:
          - exp_labels:
              alertname: Central availability error budget exhaustion - 50%
              namespace: rhacs-abc
              rhacs_instance_id: rhacs-abc
              service: central
              grpc_service: grpcsvc
              grpc_method: grpcmeth
              severity: warning
            exp_annotations:
              message: "Latency error budget exhaustion for central's GRPC API. Current exhaustion: 91.77%."
      - eval_time: 28d
        alertname: Central latency error budget exhaustion for HTTP API - 90%
        exp_alerts:
          - exp_labels:
              alertname: Central availability error budget exhaustion - 90%
              namespace: rhacs-abc
              rhacs_instance_id: rhacs-abc
              service: central
              grpc_service: grpcsvc
              grpc_method: grpcmeth
              severity: critical
            exp_annotations:
              message: "Latency error budget exhaustion for central's HTTP API. Current exhaustion: 91.77%."
      - eval_time: 28d
        alertname: Central latency error budget exhaustion for HTTP API - 70%
        exp_alerts:
          - exp_labels:
              alertname: Central availability error budget exhaustion - 70%
              namespace: rhacs-abc
              rhacs_instance_id: rhacs-abc
              service: central
              grpc_service: grpcsvc
              grpc_method: grpcmeth
              severity: warning
            exp_annotations:
              message: "Latency error budget exhaustion for central's HTTP API. Current exhaustion: 91.77%."
      - eval_time: 28d
        alertname: Central latency error budget exhaustion for HTTP API - 50%
        exp_alerts:
          - exp_labels:
              alertname: Central availability error budget exhaustion - 50%
              namespace: rhacs-abc
              rhacs_instance_id: rhacs-abc
              service: central
              grpc_service: grpcsvc
              grpc_method: grpcmeth
              severity: warning
            exp_annotations:
              message: "Latency error budget exhaustion for central's HTTP API. Current exhaustion: 91.77%."
  - interval: 10m
    input_series:
      - series: central:grpc_server_handling_seconds:rate10m:p90{namespace="rhacs-abc", grpc_service="grpc_service", grpc_method="grpc_method"}
        values: "1+0x2 0+0x2"
      - series: central:http_incoming_request_duration_histogram_seconds_bucket:rate10m:p90{namespace="rhacs-abc", path="path"}
        values: "1+0x2 0+0x2"
    alert_rule_test:
      - eval_time: 1h
        alertname: Central latency burn rate for GRPC API
        exp_alerts:
          - exp_labels:
              alertname: Central latency burn rate for GRPC API
              namespace: rhacs-abc
              rhacs_instance_id: rhacs-abc
              service: central
              grpc_service: grpc_service
              grpc_method: grpc_method
              severity: warning
            exp_annotations:
              message: "Latency  burn rate for central's GRPC API. Current burn rate per hour: 50."
      - eval_time: 1h
        alertname: Central latency burn rate for HTTP API
        exp_alerts:
          - exp_labels:
              alertname: Central latency burn rate for HTTP API
              namespace: rhacs-abc
              rhacs_instance_id: rhacs-abc
              service: central
              path: path
              severity: warning
            exp_annotations:
              message: "Latency  burn rate for central's HTTP API. Current burn rate per hour: 50."
