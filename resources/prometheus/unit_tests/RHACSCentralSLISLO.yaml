rule_files:
  - /tmp/prometheus-rules-test.yaml

evaluation_interval: 30s

group_eval_order:
  - rhacs-central.sli
  - rhacs-central.slo
  - rhacs-central.alerts

tests:
  # Central availability error budget exhaustion - 90%
  - interval: 5m
    input_series:
      # 200m downtime due to pod not ready. Out of 28 days, this equates to ~0.5% downtime.
      - series: kube_pod_container_status_ready{container="central", pod="central-test1", namespace="rhacs-test1"}
        values: "1+0x260 0+0x40 1+0x100"
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="OK", namespace="rhacs-test1", rhacs_instance_id="test"}
        values: "1+1x400"
      - series: grpc_server_started_total{job="central", grpc_type="unary", namespace="rhacs-test1", rhacs_instance_id="test"}
        values: "1+1x360 362+2x40"
      - series: http_incoming_requests_total{job="central", code="200", namespace="rhacs-test1", rhacs_instance_id="test"}
        values: "4+4x400"
      # 200m downtime due NOK or 5xx responses. Out of 28 days, this equates to ~0.5% downtime.
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="NOK", namespace="rhacs-test1", rhacs_instance_id="test"}
        values: "0+0x360 0+1x40"
      - series: http_incoming_requests_total{job="central", code="500", namespace="rhacs-test1", rhacs_instance_id="test"}
        values: "0+0x360 0+4x40"
    alert_rule_test:
      - eval_time: 100m
        alertname: Central availability error budget exhaustion - 90%
        exp_alerts: []
      - eval_time: 2000m
        alertname: Central availability error budget exhaustion - 90%
        exp_alerts:
          - exp_labels:
              alertname: Central availability error budget exhaustion - 90%
              service: central
              severity: critical
              namespace: rhacs-test1
              rhacs_instance_id: test
            exp_annotations:
              message: "High availability error budget exhaustion for central. Current exhaustion: 97.97%."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-018-rhacs-central-slo-alerts.md"

  # Central availability error budget exhaustion - 70%
  - interval: 5m
    input_series:
      # 175m downtime due to pod not ready. Out of 28 days, this equates to ~0.43% downtime.
      - series: kube_pod_container_status_ready{container="central", pod="central-test2", namespace="rhacs-test2"}
        values: "1+0x265 0+0x35 1+0x100"
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="OK", namespace="rhacs-test2", rhacs_instance_id="test"}
        values: "1+1x400"
      - series: grpc_server_started_total{job="central", grpc_type="unary", namespace="rhacs-test2", rhacs_instance_id="test"}
        values: "1+1x365 367+2x35"
      - series: http_incoming_requests_total{job="central", code="200", namespace="rhacs-test2", rhacs_instance_id="test"}
        values: "4+4x400"
      # 175m downtime due NOK or 5xx responses. Out of 28 days, this equates to ~0.43% downtime.
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="NOK", namespace="rhacs-test2", rhacs_instance_id="test"}
        values: "0+0x365 0+1x35"
      - series: http_incoming_requests_total{job="central", code="500", namespace="rhacs-test2", rhacs_instance_id="test"}
        values: "0+0x365 0+4x35"
    alert_rule_test:
      - eval_time: 100m
        alertname: Central availability error budget exhaustion - 70%
        exp_alerts: []
      - eval_time: 2000m
        alertname: Central availability error budget exhaustion - 70%
        exp_alerts:
          - exp_labels:
              alertname: Central availability error budget exhaustion - 70%
              service: central
              severity: warning
              namespace: rhacs-test2
              rhacs_instance_id: test
            exp_annotations:
              message: "High availability error budget exhaustion for central. Current exhaustion: 85.57%."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-018-rhacs-central-slo-alerts.md"

  # Central availability error budget exhaustion - 50%
  - interval: 5m
    input_series:
      # 105m downtime due to pod not ready. Out of 28 days, this equates to ~0.25% downtime.
      - series: kube_pod_container_status_ready{container="central", pod="central-test3", namespace="rhacs-test3"}
        values: "1+0x279 0+0x21 1+0x100"
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="OK", namespace="rhacs-test3", rhacs_instance_id="test"}
        values: "1+1x400"
      - series: grpc_server_started_total{job="central", grpc_type="unary", namespace="rhacs-test3", rhacs_instance_id="test"}
        values: "1+1x379 381+2x21"
      - series: http_incoming_requests_total{job="central", code="200", namespace="rhacs-test3", rhacs_instance_id="test"}
        values: "4+4x400"
      # 105m downtime due NOK or 5xx responses. Out of 28 days, this equates to ~0.25% downtime.
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="NOK", namespace="rhacs-test3", rhacs_instance_id="test"}
        values: "0+0x379 0+1x21"
      - series: http_incoming_requests_total{job="central", code="500", namespace="rhacs-test3", rhacs_instance_id="test"}
        values: "0+0x379 0+4x21"
    alert_rule_test:
      - eval_time: 100m
        alertname: Central availability error budget exhaustion - 50%
        exp_alerts: []
      - eval_time: 2000m
        alertname: Central availability error budget exhaustion - 50%
        exp_alerts:
          - exp_labels:
              alertname: Central availability error budget exhaustion - 50%
              service: central
              severity: warning
              namespace: rhacs-test3
              rhacs_instance_id: test
            exp_annotations:
              message: "High availability error budget exhaustion for central. Current exhaustion: 50.84%."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-018-rhacs-central-slo-alerts.md"

  # Central high availability burn rate
  - interval: 5m
    input_series:
      # 30m downtime due to pod not ready.
      - series: kube_pod_container_status_ready{container="central", pod="central-test4", namespace="rhacs-test4"}
        values: "1+0x6 0+0x6"
      - series: grpc_server_handled_total{job="central", grpc_type="unary", grpc_code="OK", namespace="rhacs-test4"}
        values: "5+5x14"
      - series: grpc_server_started_total{job="central", grpc_type="unary", namespace="rhacs-test4"}
        values: "5+5x14"
      - series: http_incoming_requests_total{job="central", code="200", namespace="rhacs-test4"}
        values: "5+5x14"
    alert_rule_test:
      - eval_time: 30m
        alertname: Central high availability burn rate
        exp_alerts: []
      - eval_time: 70m
        alertname: Central high availability burn rate
        exp_alerts:
          - exp_labels:
              alertname: Central high availability burn rate
              service: central
              severity: critical
              namespace: rhacs-test4
            exp_annotations:
              message: "High availability burn rate for central. Current burn rate per hour: 59.17."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-018-rhacs-central-slo-alerts.md"
